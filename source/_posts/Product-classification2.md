---
title: 质监数据学习技术报告
date: 2018-10-30 20:25:55
tags:
description: 对质监项目进行总结报告。
---

对质监项目进行总结报告。
<!-- TOC -->

- [项目背景](#项目背景)
- [质监项目相关数据](#质监项目相关数据)
    - [部分关系数据表](#部分关系数据表)
        - [已检测的产品信息表 check.csv](#已检测的产品信息表-checkcsv)
        - [所有产品信息表 product.csv](#所有产品信息表-productcsv)
        - [公司信息表 company.csv](#公司信息表-companycsv)
    - [可用于构建网络结构的关系表](#可用于构建网络结构的关系表)
        - [股东信息表 investmentRalition.csv](#股东信息表-investmentralitioncsv)
        - [法人代表人信息表 legal_company.csv](#法人代表人信息表-legal_companycsv)
        - [其他关系数据](#其他关系数据)
    - [现有数据的相关问题](#现有数据的相关问题)
- [网络表示学习相关工作](#网络表示学习相关工作)
    - [基于图卷积的方法 GCN](#基于图卷积的方法-gcn)
    - [基于metapath的异质网络表示学习 metapath2vec](#基于metapath的异质网络表示学习-metapath2vec)
- [部分实验](#部分实验)
    - [数据预处理](#数据预处理)
        - [缺失数据处理](#缺失数据处理)
        - [非数值属性的量化](#非数值属性的量化)
        - [特征提取](#特征提取)
        - [待分类产品product.csv数据表的问题](#待分类产品productcsv数据表的问题)
        - [部分实验结果](#部分实验结果)
            - [训练集与测试集划分及类别不平衡问题](#训练集与测试集划分及类别不平衡问题)
            - [01取值和排序量化的实验](#01取值和排序量化的实验)
            - [分类阈值的实验](#分类阈值的实验)
    - [使用网络表示学习的分类](#使用网络表示学习的分类)
        - [使用随机路径metapath2vec的方法](#使用随机路径metapath2vec的方法)
        - [对企业进行分类](#对企业进行分类)
- [总结](#总结)
    - [现有问题](#现有问题)
    - [有意义的结论和发现](#有意义的结论和发现)

<!-- /TOC -->
# 项目背景

质监项目来自于国家质量监督检验有关部门对企业产品进行质量监督抽查这一活动。质量技术监督有关部门为监督产品质量，会依法组织对企业产品进行随机抽样、检验的活动。相关部门会根据检测的结果对不合格的产品要求整改、重新检验等。

基于部分检测结果，我们认为对剩下的没有检测的产品，他们之间的某些关系，比如同类别、同区域公司或同一股东投资的公司之间可能具有相似性，于是可以对未检测的产品做一个分类的预测，以期对质监活动做一个指导作用。

如图1所示，基于已有的产品关系表和企业关系表，可以构建企业和产品的关系图，基于企业投资关系，可以构建图2所示的企业股东关系图。

简而言之，我们试图做的事情和解决的问题包括：

- 根据部分已经抽样检测的产品，对未检测的产品做分类的预测
- 希望探究产品的合格与否和他所属的公司、以及公司之间存在的某些联系是否有关
- 为质监产品抽查工作提供帮助

![图1. 企业产品关系图](/images/zjbg/Company_Product.png) | ![图2. 企业股东关系图](/images/zjbg/qiyegudong.png)
:------:|:---:
|

# 质监项目相关数据

简要说明该项目使用的关系数据表，主要包括已检测的产品表、所有产品信息表、公司信息表、企业法人信息表、企业股东关系等其他关系表。

## 部分关系数据表

> 在dict.xlsx文件中有对check.csv,prodcut.csv和company.csv文件的字段说明，但是其中有很多属性缺失的情况，比如check.csv中的scale属性和scalecontent属性在dict.xlsx中存在，但在check.csv中没有scale属性。另外,以check表为例，check表和product表可能来自不同的数据库，属性差异较大，没有准确的完整的属性对应，导致后面某些实验在特征提取，模型泛化时会遇到问题。

### 已检测的产品信息表 check.csv

包含60581条数据，每条数据包含37个属性,详细属性信息见dict.xlsx文件说明。其中表中列出的属性有一部分在数据文件中不存在，在对每一条记录进行筛选和过滤后得到大约35992条记录 。详细过程可见数据预处理部分。

这些产品分布于9358家公司，其中有1599家含有未通过的产品。

### 所有产品信息表 product.csv

产品表包含所有产品的信息，根据统计，有339816条产品记录。
该表中并没有明确的主键，无法找到和check.csv中对应的产品记录。但根据统计check.csv中产品的所属公司信息，和product.csv中产品的公司信息，发现两个表中的所有产品对应的公司集合几乎是不相交的，所以我们认为已检测的产品check.csv和product.csv是互斥的。这也为后面的网络表示学习带来了一些影响。

另外一个方面，check.csv和product.csv两个表的属性结构差异也较大。根据dict.xlsx文件的说明，check.csv有104个属性信息，而product.csv仅有10个属性信息，这还不包括确实的属性和空值的属性。对product.csv文件进行了一些过滤之后，可以提取使用的特征少之又少，还存在取值意义不明确的情况。由此也带来了一些问题，导致根据以检测的产品数据处理训练出来的模型很难应用在剩余的产品数据上，进行分类预测。

### 公司信息表 company.csv

包含2276305家公司的基本信息，其中和所有产品有关的公司有111183家。

该表包含43个属性。

## 可用于构建网络结构的关系表

### 股东信息表 investmentRalition.csv

记录每个公司的股东信息，其中原始表中有1525555条记录，但与产品相关公司有关的记录只有96850条。因为我们比较看重同一个股东投资的不同公司之间是否具有相似性，所以统计了包含了投资多个（至少两个）公司的股东的记录，结果只有7365条。

### 法人代表人信息表 legal_company.csv

包含每个公司的法人代表人（?）信息，其中原始表中有577012条记录，但与产品相关公司有关的记录只有26557条,包含了同时作为多个（至少两个）公司的法人代表人的记录，结果只有8194条。

### 其他关系数据

其他数据信息还有：企业高管信息、企业股东资本信息、企业所获荣誉信息、企业部分员工信息等等。

但由于这些数据来源比较混乱，多数通过网络爬虫等方式获得，每个表中的数据大都只有几百条，很难作为有用的数据进行处理和使用，所以就大部分没有进行处理和使用，也不在这里讨论。

## 现有数据的相关问题

现有数据存在一些问题，导致后面的数据挖掘工作存在一些难度。

1. 数据缺失
   - 几个关系数据都存在属性缺失的问题，即在dict.xlsx中出现的属性，在实际数据文件中不存在
   - 属性值空缺，大量的属性取值都是空白状态，其中有的是无用属性，也有部分可能有用属性

2. 不同关系中的主要属性的对应问题。如check.csv中的经济类型和company.csv中的经济类型键的名称不一致，无法直接对应，也无法判断两个属性是否取相同的值。同时也存在确实问题。

3. 可用属性较少。如product.csv经过处理后只有一两个属性可用，使得直接对所有产品进行分类的难度较大。

4. 生成的网络结构较稀疏。由于只能使用企业股东信息和法人等信息构建网络，而这几个关系数据较少，生成的网络结构大多是两三个节点连接在一起，使得网络表示学习算法很难得到好的结果

5. 网络结构不均匀。前面已经说过，已检测的产品所属的公司和剩余产品所属的公司差不多是互斥的关系，致使后面在使用网络表示学习的分类算法时效果较差。

# 网络表示学习相关工作

这个项目最初的想法是利用关系数据构建网络，使用前沿的网络表示学习算法进行产品的分类任务。利用网络表示学习，主要进行下面两方面的工作：

- 利用网络结构，来帮助我们进行产品的预测分类，假设认为网络结构的某些信息会对分类有帮助。比如我们认为同一个人投资的公司会具有相似性，这个人可能具有好的判断力，投资的都是高质量的公司，这些公司可能产品的合格率都很高，如果我们在已分类的产品中有的公司产品合格率高，那么这个投资人投资的其他公司可能合格率也会很高。上面的想法只是假设，可以利用网络表示学习的方法验证他的有效性。
- 提取隐藏的特征。原来基于关系数据提取的特征依赖于关系数据的属性定义，利用网络学习表示算法，可以提取图结构的隐藏特征。比如没有连接关系的两个公司，但它们的网络结构可能是相似的，生产相似的产品、产品数等，可能对分类带来帮助。

下面介绍一些本文主要用到的网络表示学习相关算法，在方法的细节上不会过多说明，简要说明一下自己的理解，和方法的利弊。

## 基于图卷积的方法 GCN

关于图卷积的概念，这里不做太多解释。简而言之，对于一个节点要生成一个最终的特征向量，在每个卷积层他会计算自身和相邻节点的输入向量，生成输出向量，如果考虑k紧邻节点，则设置为k个卷积层的神经网络。

由于GCN的方法是在普通同质网络上使用的，关于同质网络和异质网络可以参考之前的博客[网络中的节点分类](/2018/07/27/Product-classification)。是的它不能直接使用在我们的数据中。另外，我们的数据不仅仅是产品、公司、股东等类型作为异质的节点，在产品这类节点中，由于check表和product表的不对应，导致check和其他product需要作为两类节点进行考虑，这使得原本的半监督问题出现问题。

## 基于metapath的异质网络表示学习 metapath2vec

metapath2vec用来处理异质网络，它可以提取异质网络的网络结构信息，不能直接用来进行节点的分类，也不会直接利用节点原来的特征信息。我们可以在提取完网络结构信息后，对结构向量和原本特征向量进行拼接，利用其他机器学习分类器进行分类。

这里说明一下metapath的思路，如何提取网络结构信息，和他的不足之处。

metapath2vec来自于同质网络的deep walk模型，deep walk模型来自于word2vec模型。

word2vec模型是Google公司在自然语言处理中使用的一个模型，它做的事情是对自然语言，如英文的每个单词生成一个特定的向量表达，有了向量之后可以应用很多的机器学习方法做其他的事情。如何生成每个单词的向量那，最基本的假设是认为：在自然语言中，一条语句中频繁相邻出现的词语，他们的向量应当是相似的。基于这一假设，利用神经网络模型和庞大的自然语言数据库，不停地进行训练，最后可以得到每个单词的向量表达。在这个过程中，需要大量的训练数据和训练时间。

而deep walk利用了word2vec的思想，他们认为在一个足够大的网络中，网络节点度数对应的节点数的分布和自然语言中单词出现频率对应的单词数的分布是相似的，利用这一相似性，可以使用同样的模型对网络中的节点生成向量表达。唯一的不同之处是，对于自然语言的一条语句，在网络中，可以利用一条随机路径来代替，每一个节点相当于一个单词，一条随机游走的路径相当于一条自然语言语句。相邻的节点自然出现的频率更高，最后生成的向量也会相似。在这个过程中，需要生成足够多的随机路径，个人认为，网络结构要足够大，足够均匀才能有好的效果。

metapath2vec方法则解决原来方法在异质网络上的缺陷，通过定义异质网络上随机游走的pattern来提高路径的质量，比如一条路径当前节点是公司，强制让下一个节点时产品，在强制让下一个节点是公司。以原论文实验为例，论文中将方法在学术网络数据集上进行实验，学术网络就是会议、论文、作者等构成的异质网络，在分类实验中，对主要的会议进行分类。以每个会议的方向作为类别，大致分为8个方向，如软件工程、机器学习等。最后的分类结果很好，但个人认为这是必然的，因为在一个足够大的学术网络中，指论文足够多，每个作者研究的方向必然是一致的或者相关度很高的，他投出的论文所属的会议也会基本是一个方向，那么整个大的网络会由论文和作者的关系构成8个密集度很高的小的网络，只要训练的时间够长，路径够多，那么每个小的网络中每个节点的向量表达必然是相似的，分类结果自然也就很好。

在我们的数据中，由于整个网络无法完全联通或尽可能连同，只能构成一个个小的分支，所以很难生成高质量的路径。另外，基于随机路径的方法个人认为是不能挖掘前面提到的图结构的隐藏特征的，或者在我们的数据中是做不到的。而且由于check和product的互斥性，也很难对剩余的产品生成有意义的向量。

# 部分实验

## 数据预处理

原始数据包括check.csv. product.csv  company.csv和少量其他关系数据，如 股东关系，企业投资关系，法人关系，企业荣誉等

check.csv 抽检过的部分产品信息
包含 60581条数据，每条数据包含37个属性,详细属性信息见dict.xlsx文件说明。其中表中列出的属性有一部分在数据文件中不存在
分布于9358家公司，其中有1599家含有未通过的产品

company.csv 企业信息
包含2276305条数据，含产品的公司有111183家

product.csv 未检测产品信息
包含339816条数据

### 缺失数据处理

根据领域知识（人为观察和思考认为和检测分类结果没有关系的属性）和表中实际属性值的分布（大部分或者全部分都是空缺，或者噪声较大较多的），过滤掉没有用的属性，保留10个属性具体如下：

"ID","ORGNAME","SCALECONTENT","ECONOMYTYPECONTENT","ORGANNO","PRODUCTTYPE","SALESVOLUME","ENTITYISPASS","ISPASS","POST"
"257244","山东亿家福家居用品有限公司","小型企业","有限责任公司","66706579","木家具","2400.0000","是","是","262600"

解释：

- ID 产品ID
- orgname 组织名称，也就是生产公司
- scalecontent  企业规模描述（dict.xlsx中有scale 企业规模属性 ，但数据文件中没有，企业类型同）
- economytypecontent 企业类型描述
- organno. 企业编号
- producttype 产品类型
- salesvolume 产品销售额（万元）
- entityispass 实物质量判定是否合格1 0
- ispass 综合判定1 0
- post 邮政编码

对原数据文件进行数据过滤，剔除掉属性信息不完整的数据和包含错误，不好处理的数据.
过滤后包含35992条数据 其中通过32875 未通过3117

最终使用的特征

- producttype
- post
- scalecontent
- economytypecontent
- salsvolume

### 非数值属性的量化

对于非数值属性，比如产品类型，属性取值有很多，如：

- 木家具
- 显示器(仪、屏、箱)
- CDMA移动电话
- GSM、GPRS移动电话
- PET瓶

等.

统计过滤后的数据共有996种产品类型，应用带节点属性的异质网络学习器需要将属性转化为数值属性。
常用的方法0 1 向量法。比如对于产品类型，可以用996维的 0 1向量表示，但这样每个产品的属性向量中的一部分,即996维中只有一维是1，其他全是0,特征十分稀疏，且产品数据还有其他的非数值属性，如果全部使用此方法，得到的产品特征向量将会非常大，且不易计算。

在实验中，我们通过计算所有属性取值对应的标记分布，进行取值的排序，然后转化成01区间内的连续数值，来进行非数值属性的量化。这里假设认为这些非数值属性的取值和分类结果是有序相关的，后面可以用分类器进行实验01取值和这种方法的对比。

利用已有的标记信息，我们计算每个属性取值和标记的关系，比如现在有取值 木家具 显示器 电话，他们在所有标记数据中共出现 4 6 8 次，其中不合格的数据分别有 0 0 2,那么我们认为电话不合格的可能性更高一些，木家具和显示器虽然都没有不合格项数，但显示器基数更大，那么显示器更接近合格，则把他们转化成连续的数值属性，并进行归一化，木家具，显示器，电话对应的数值属性可能是0.5，0和1.

一个潜在的问题是该方法在泛化性能上可能会有缺陷，未监测数据中可能存在已监测数据中没有的属性取值，则无法将其对应到01区间。可实验的解决方法是，对这些取值取平均值，如0.5，或者计算他们的分布数量，和已有的进行比较，取相似度高的分布。

### 特征提取

对过滤后的属性进行特征提取，使用包裹式方法，每次添加一个属性，使用logistic regression分类器进行实验，测试该属性对分类结果的影响，最后对check数据保留5个特征，分别是：

- SALESVOLUME
- 企业规模
- 企业类型
- 产品类型
- 邮编

之后进行归一化操作.逐渐添加特征生成向量，利用logistic regression的分类结果如图3，4所示：

![图3. test size 1:1](/images/zjbg/pp1.png) | ![图4. test size 10:1](/images/zjbg/pp2.png)
:------:|:---:
|

### 待分类产品product.csv数据表的问题

已检测产品数据check和所有产品数据product对比：

check.csv表中使用的属性有：

- producttype 产品类型
- post 邮编
- scalecontent 企业规模描述（check字段表中有scale和scalecontent两个属性，但csv数据文件中只有scalecontent)，是文字描述
- economytypecontent 经济类型内容（同上，没有economytype），文字描述
- salsvolume 销售额（万元）

product.csv 缺少：

- producttype 有PROD_NM，产品名称，不能完全对应，且数目差距较大
- scalecontent 无
- economytypecontent 经济类型，只能从所属公司获得jjlx，是一个数值属性，且economytype没有和economytypecontent的映射

由于数据属性不一致使得当前模型无法应用在product.csv上。

### 部分实验结果

这部分主要记录的是利用已经检测的产品表(check.csv)进行属性特征提取，之后训练模型，进行产品分类的实验。由于已检测的产品表和所有产品表不属于同一个关系表，所以训练出来的模型暂时无法应用在所有产品上。

#### 训练集与测试集划分及类别不平衡问题

对check.csv做处理后划分训练集和测试集。划分比例9:1，训练集共32393个样本，合格29470，不合格2923。
其中明显存在类别不均衡问题，对这一问题，在训练时暂时使用欠采样方法，在29470个合格样本中随机选择2923个与不合格样本组成训练样本，生成训练模型，在测试集上进行测试。

由于check和product是互斥的，所以check中训练集的划分方式会影响分类效果。可以通过按照公司进行集合的划分，生成的训练集公司分别是互斥的和随机的。

- 互斥

|类别|precision|recall|f1|accuracy（全）|
|--|--|--|--|--|
|1（不合格）|0.07996324|0.44845361|0.13572543|0.69213670464|
|0（合格）|0.9573875|0.70602056|0.81271129||

- 随机

|类别|precision|recall|f1|accuracy（全）|
|--|--|--|--|--|
|1（不合格）|0.16947649|0.63036304|0.26713287|0.705195887747|
|0（合格）|0.95469256|0.71601942|0.81830791||

#### 01取值和排序量化的实验

主要利用已经检测的产品表(check.csv)进行属性特征提取，之后训练模型，进行产品分类。
对处理过的check 表划分训练集和测试集，划分比例9:1。实验结果显示，利用排序量化的方式生成的向量效果要好一些，分类的accuracy高4个百分点左右。（集合随机划分）

- 01方式

|类别|precision|recall|f1|accuracy（全）|
|--|--|--|--|--|
|1（不合格）|0.16136364|0.7029703|0.26247689|0.667407613226|
|0（合格）|0.960509|0.66413835|0.78529148||

- 排序量化方式

|类别|precision|recall|f1|accuracy（全）|
|--|--|--|--|--|
|1（不合格）|0.16947649|0.63036304|0.26713287|0.705195887747|
|0（合格）|0.95469256|0.71601942|0.81830791||

#### 分类阈值的实验

分类器会对产品生成01之间的数值，作为预测结果，通常阈值为0.5，大于0.5为正例，小于0.5为反例。通过调整阈值，可以控制分类的precision和recall，比如我们会更希望机器预测的不合格产品的正确率更高，或者希望机器能将尽可能多的不合格产品预测出来，而不关心它预测的不合格产品里加杂了更多的合格产品，这两个方向。

我们通过刻画pr曲线和roc曲线来实验阈值，如图5，6所示。实验结果一般，原因是测试集中的列别偏差较大。

![图5. pr曲线](/images/zjbg/pr2.png) | ![图6. roc曲线](/images/zjbg/roc-curve.png)
:------:|:---:
|

## 使用网络表示学习的分类

### 使用随机路径metapath2vec的方法

之前blog[网络中的节点分类](/2018/07/27/Product-classification)中使用该方法生成了每个节点的网络结构向量，再进行产品的分类实验，存在一些问题。

- 随机路径的质量不高，很难生成好的向量
- 评价指标有问题，原来只考虑了两类的macro-f1， 有0.47，实质上由于类别严重不均衡，不合格类的f1很低，而合格类的f1很高，得到的macro-f1看起来还不错的样子。实质上分类器并没有起到好的效果。

### 对企业进行分类

我们根据已经被检测的企业他们的产品检测结果，将被检测企业分为两类，含有未通过产品的企业和全部通过的企业，尝试对企业进行分类并探究企业股东或者法人关系下的企业相关性。

首先对企业进行特征提取。在观察了已有数据数据后，共提取了五项特征，包括：企业产品总数、企业评奖评优数、注册资金、员工数、企业规模。其中企业评奖评优数只有部分很小的数据，只有很少一部分企业有这个数据，注册资金和员工数有很多空缺，并没有实验影响。

我们基于这五个特征做了分类实验，测试了特征是否有效，使用logisticRegression进行分类，其中经过筛选后实验数据包含正例10680，反例2592。在实验中，每次随机从正例集合中取出2592个数据和反例组成实验数据，划分训练集和测试集。划分比例从0.1到0.9，每次训练20次，取平均值测试结果如下：

 | k(训练集占比) | 0.1 | 0.2 | 0.3 | 0.4 | 0.5 | 0.6 | 0.7 | 0.8 | 0.9 |
 | - | - | - | - | - | - | - | - | - | - |
 | accuracy | 0.588 | 0.591 | 0.589 | 0.591 | 0.592 | 0.593 | 0.593 | 0.593 | 0.594 |
 | macro f1 | 0.585 | 0.588 | 0.585 | 0.588 | 0.589 | 0.589 | 0.588 | 0.588 | 0.589 |

考虑到很多公司的属性值不完全，实验效果还可以接受。

之后使用企业股东关系和企业法人关系构建了简单的图结构。由于这一部分关系的数据非常少，造成结构非常稀疏，我们为了探究企业法人和股东关系对企业的影响，去除了部分没有企业法人和股东的数据，只保留还有这些关系的数据。尽管如此，最后的图还是非常松散的，可能一个节点只通过一条边和另外一个节点相连，整个图可能是有很多个两个节点连通的子图构成的。

我们使用GCN模型进行实验。GCN模型的基本思想是图结构中相邻节点具有相似性，每进行一次卷积，会使用该节点的所有近邻对自己进行更新，模型中的网络层数决定了它能考虑几阶近邻。利用这一方法，实验股东关系和法人关系的影响。在这里我们对图的结构进行了简化，只保留了公司节点，对同一个股东或同一个法人的两个公司生成一条边。

对数据过滤后，保留含有边的节点，最后得到的数据包含83个反例和565正例。按照正反例同等大小划分训练数据，分别进行不包含邻接关系的gcn分类和包含邻接关系的GCN分类，分别进行10次实验，得到的准确率结果如下

 | | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | Max | average |
 | - | - | - | - | - | - | - | - | - | - | - | - | - |
 | 含有邻接 | 0.62 |  0.54 |  0.50  | 0.60  | 0.56  | 0.48  | 0.52  | 0.64  | 0.60  | 0.62 | 0.64 | 0.568 |
 | 不含邻接 | 0.60  | 0.56  | 0.50  | 0.52  | 0.52  | 0.48  | 0.48  | 0.52  | 0.60  | 0.54 | 0.60 | 0.532 |

实验说明股东关系和法人关系有一些影响，但可能因为特征属性的缺失，边数量较少等，效果不明显。

# 总结

## 现有问题

对于一个数据挖掘或者机器学习模型，最基本的假设是训练数据和待应用数据应该符合同一个分布，但我们的数据存在分布差异的问题，具体如下。

已检测产品 作为训练数据，未检测产品 作为待分类产品

1. 两者应该符合同一分布
    - 产品合格率分布相似
    - 部分特征取值的分布是否相似。例如：已检测的产品所属的类别和剩余产品的类别分布是否相似，实际上已检测的产品共有993种产品类型，剩余产品以产品名称（或执行标准）为划分共有62161 （57294）种（没有直接对应，另一个问题）。个人认为是互斥或前者是后者的一个很小的子集。
    - 已检测的产品所属的公司和未检测产品的公司存在互斥，公司之间缺乏明显的相关性
2. 已检测的产品和未检测产品未拥有同样可用的特征
    - check表和product表来自不同的数据库，属性差异较大，没有准确的完整的对应，导致无法生成相应的特征，训练的模型无法泛化

## 有意义的结论和发现

1. 在对产品进行特征提取的实验中，实验的结果使我们有理由相信，产品的合格率是跟产品的类别有关的。
2. 在利用GCN模型对公司进行的分类实验中，虽然添加了网络连接的分类结果提高不大，但也足够说明，具有相同股东和/或法人的公司之间存在一定的产品合格相关性。